# Copilot guide for VSPlot

## Extension overview

- VSPlot is a VS Code extension that parses tabular data (CSV, JSON, TXT, DAT, TSV, TAB, OUT, DATA) and opens two webviews: `vsplot.dataPreview` for tables and `vsplot.chartView` for Chart.js visualizations.
- `src/extension.ts` activates once the views open, wiring `DataPreviewProvider`, `ChartViewProvider`, and the command layer in `src/commands/dataCommands.ts`.

## Key entry points

- `parseDataFile` in `src/data/load.ts` handles format dispatch, delimiter auto-detection, and comment filtering (default markers `#, %, //`; override via options or webview messages).
- Webview providers live in `src/providers/`; HTML/JS/CSS assets live under `media/chartView` and `media/dataPreview`, loaded through `loadHtmlTemplate` with `{{PLACEHOLDER}}` replacement.
- Webview messaging uses `type` strings: extension sends `showData` / `showChart`, webviews reply with `exportData`, `createChart`, `exportChart`, and test hooks `vsplot:test:*` used by `extension.test.ts`.

## Build & run workflow

- Install dependencies with `npm install`, then compile via `npm run compile` or `npm run watch` during development.
- Always run `npm run copy-vendor` before packaging so Chart.js bundles in `media/` stay current.
- Use VS Code Extension Development Host (F5) plus `sample-data/` fixtures (generated by `bash scripts/setup-test-data.sh`) to manually validate UI changes.

## Testing expectations

- Automated tests run through `npm test` (vscode-test); `npm run test:coverage` uses the `vscode-test` CLI with coverage thresholds enforced by `scripts/check-coverage.mjs` (see `docs/TESTING_COVERAGE.md`).
- Parser and delimiter logic is extensively covered in `src/test/*.test.ts`; when altering parsing, update fixtures in `test-data/` via the setup script and keep message contracts intact.

## Coding conventions

- TypeScript uses ESLint (`.eslintrc.json`) with `@typescript-eslint` rules: camel/Pascal case imports, braces on conditionals, semicolons enforced via `@typescript-eslint/semi`.
- Prefer async/await with VS Code APIs and return typed `Promise<ParsedData | null>` from parsing helpers; surface user-facing failures with `vscode.window.showErrorMessage` for consistency.
- Webview templates require CSP-safe scripts: generate nonces with `getNonce()` and inject URIs using `webview.asWebviewUri`.

## Data preview specifics

- The data preview webview expects `ParsedData` shape `{ headers, rows, totalRows, detectedDelimiter }`; pagination respects `vsplot.rowsPerPage` and compact/icon toggles from extension configuration.
- Delimiter overrides are processed through `reparse` messages; ensure new options round-trip through `DataPreviewProvider._wireMessageHandlers` and `parseDataFile`.

## Chart view specifics

- Chart rendering relies on locally copied `chart.umd.js`, `chartjs-plugin-zoom.umd.js`, and `chartjs-adapter-date-fns.bundle.js`; keep versions aligned with `package.json` when updating.
- Chart state is persisted via VS Code view state; test hooks `vsplot:test:setConfig` & `vsplot:test:getState` must remain functional for integration tests in `extension.test.ts`.

## When updating

- Reflect UX or parsing changes in relevant docs (`docs/WEBVIEW_ARCHITECTURE.md`, `docs/DELIMITER_DETECTION.md`, `docs/COMMENT_HANDLING.md`) and webview READMEs.
- For new data formats or comment markers, extend `parseDataFile`, update docs, add fixtures in `sample-data/` or `test-data/`, and cover them with Mocha tests.
